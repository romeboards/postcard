(function(g,l,q){function k(a,b){if(g.CustomEvent)var d=new CustomEvent(b);else d=l.createEvent("CustomEvent"),d.initCustomEvent(b,!0,!0);a.dispatchEvent(d)}function t(a){a=a||{};for(var b=1;b<arguments.length;b++)if(arguments[b])for(var d in arguments[b])arguments[b].hasOwnProperty(d)&&(a[d]=arguments[b][d]);return a}var u={_keyStr:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",decodeArrayBuffer:function(a){var b=new ArrayBuffer(a.length/4*3);this.decode(a,b);return b},decode:function(a,
b){var d=this._keyStr.indexOf(a.charAt(a.length-1)),c=this._keyStr.indexOf(a.charAt(a.length-2)),f=a.length/4*3;64==d&&f--;64==c&&f--;var n,m,r,e,p=0,g=0,d=b?new Uint8Array(b):new Uint8Array(f);a=a.replace(/[^A-Za-z0-9\+\/\=]/g,"");for(p=0;p<f;p+=3)n=this._keyStr.indexOf(a.charAt(g++)),m=this._keyStr.indexOf(a.charAt(g++)),c=this._keyStr.indexOf(a.charAt(g++)),e=this._keyStr.indexOf(a.charAt(g++)),n=n<<2|m>>4,m=(m&15)<<4|c>>2,r=(c&3)<<6|e,d[p]=n,64!=c&&(d[p+1]=m),64!=e&&(d[p+2]=r);return d}},s=function(){function a(a,
b){var c=l.createElement("script"),g=!1;c.src=a;c.async=!0;var e=b||f.error;"function"===typeof e&&(c.onerror=function(b){e({url:a,event:b})});c.onload=c.onreadystatechange=function(){g||this.readyState&&"loaded"!==this.readyState&&"complete"!==this.readyState||(g=!0,c.onload=c.onreadystatechange=null,c&&c.parentNode&&c.parentNode.removeChild(c))};d||(d=l.getElementsByTagName("head")[0]);d.appendChild(c)}var b=0,d,c=this,f={};return{get:function(d,m,g,e){var h=-1===(d||"").indexOf("?")?"?":"&",l;
e=e||f.callbackName||"callback";var k=e+"_json"+ ++b;m=m||{};for(l in m)m.hasOwnProperty(l)&&(h+=encodeURIComponent(l)+"="+encodeURIComponent(m[l])+"&");c[k]=function(a){g(a);try{delete c[k]}catch(b){}c[k]=null};a(d+h+e+"="+k);return k},init:function(a){f=a}}}();XMLHttpRequest.prototype.sendAsBinary===q&&(XMLHttpRequest.prototype.sendAsBinary=function(a){a=Array.prototype.map.call(a,function(a){return a.charCodeAt(0)&255});this.send((new Uint8Array(a)).buffer)});var v={height:"",width:"",proxyURL:"http://lab.layerframe.com/postcard/scripts/image_proxy.php",
filename:"yourpostcard.png",backgroundImgUrl:"",backgroundColor:"#fff",fontFamily:"sans-serif",fontSize:"16px",fontColor:"#fff",fontStyle:"normal",fontWeight:"normal"},w={isOpera:!1,isFirefox:!1,isSafari:!1,isChrome:!1,isIE:!1},h={init:function(a){this.element=this;this.options=t({},v,a);this.browser=w;this.browser.isOpera=!(!g.opera||!g.opera.version);this.browser.isFirefox="MozBoxSizing"in l.documentElement.style;this.browser.isSafari=0<Object.prototype.toString.call(g.HTMLElement).indexOf("Constructor");
this.browser.isChrome=!this.browser.isSafari&&"WebkitTransform"in l.documentElement.style;this.browser.isIE="msTransform"in l.documentElement.style;this._height=this.options.height=this.element.height;this._width=this.options.width=this.element.width;this._ctx=this.element.getContext("2d");s.init({error:function(a){console.error("Failed to load : "+a.url)}});this._text=[];this._images=[];this._oldtext=[];this._oldimages=[];this.options.backgroundImgUrl.length&&h.addImage.apply(this,[this.options.backgroundImgUrl,
0,0,this._width,this._height]);e.drawInit.apply(this)},addImage:function(a,b,d,c,f){this._images.push({url:a,x:b,y:d,w:c,h:f,loaded:!1});k(this.element,"postcardimagesloading");e.getImage.apply(this,[this._images.length-1])},addImages:function(a){for(var b=0;b<a.length;b++)h.addImage.apply(this,[a[b].url,a[b].x,a[b].y,a[b].w,a[b].h])},setFont:function(a){var b=a.split(" ",4);a=a.slice(a.indexOf("px")+3);this.options.fontColor=b[0];this.options.fontStyle=b[1];this.options.fontWeight=b[2];this.options.fontSize=
b[3];this.options.fontFamily=a},setFontFamily:function(a){this.options.fontFamily=a},setFontStyle:function(a){this.options.fontStyle=a},setFontWeight:function(a){this.options.fontWeight=a},setFontSize:function(a){this.options.fontSize=a},setFontColor:function(a){this.options.fontColor=a},addText:function(a,b,d){var c={text:a,style:e.getFont.apply(this),x:b,y:d};this._text.push(c);e.setFontToCtx.apply(this);this._ctx.fillText(a,b,d)},addFullText:function(a,b,d,c){h.setFont.apply(this,[b]);h.addText.apply(this,
[a,d,c])},add:function(a){for(var b=this,d=[],c=[],f=0;f<a.length;f++)a[f].url!==q?d.push(a[f]):a[f].text!==q?c.push(a[f]):console.error("Parsing error: postcard.add()");h.addImages.apply(this,[d]);this.element.addEventListener("_loaded",function(){for(var a=0;a<c.length;a++){var d=c[a];h.addFullText.apply(b,[d.text,d.style,d.x,d.y])}this.removeEventListener("_loaded")})},setBreakpoint:function(a,b,d){var c=this,f=function(){if(g.outerWidth>a){console.log("bigger");k(c.element,"postcardresize");c.element.width=
c._width=c._oldwidth;c._oldwidth=b;var d=c._oldimages.concat(c._oldtext);c._oldimages=c._images.slice(0);c._oldtext=c._text.slice(0);e.clear.apply(c);h.add.apply(c,[d]);g.addEventListener("resize",n);g.removeEventListener("resize",f)}},n=function(){g.outerWidth<=a&&(console.log("smaller"),k(c.element,"postcardresize"),c._oldwidth=c._width,c.element.width=c._width=b,c._oldimages=c._images.slice(0),console.log(c._oldimages),c._oldtext=c._text.slice(0),e.clear.apply(c),h.add.apply(c,[d]),g.addEventListener("resize",
f),g.removeEventListener("resize",n))};g.addEventListener("resize",n)},save:function(a){if(this.browser.isSafari||this.browser.isIE)alert("danger! danger!"),a.target.setAttribute("target","_blank");a.target.href=this.element.toDataURL();a.target.download=this.options.filename},shareOnFB:function(a){var b=this,d=this.element.toDataURL("image/png"),c=this.options.filename,d=d.substring(d.indexOf(",")+1,d.length),f=u.decode(d);console.log("hello?");FB.getLoginStatus(function(d){"connected"==d.status?
(d=d.authResponse.accessToken,console.log("post?!?!?!"),e.postImageToFacebook.apply(b,[d,c,"image/png",f,a])):FB.login(function(d){e.postImageToFacebook.apply(b,[d.authResponse.accessToken,c,"image/png",f,a])},{scope:"publish_stream"})})}},e={drawInit:function(){this._ctx.rect(0,0,this._width,this._height);this._ctx.fillStyle=this.options.backgroundColor;this._ctx.fill()},getImageData:function(a){var b=/(ftp|http|https):\/\/(\w+:{0,1}\w*@)?(\S+)(:[0-9]+)?(\/|\/([\w#!:.?+=&%@!\-\/]))?/;if(a.url){var d=
"https:"===location.protocol,c="";!a.server||!b.test(a.server)||d&&0==a.server.indexOf("http:")?console.error("no server url"):c=a.server;s.get(c+"?callback=?",{url:escape(a.url)},function(b){var c=new Image;c.onload=function(){this.width=b.width;this.height=b.height;typeof a.success==typeof Function&&a.success(this)};c.src=b.data})}else typeof a.error==typeof Function&&a.error(null,"no_url")},getImage:function(a){var b=this,d=b._ctx;this._images[a].imgdata===q?e.getImageData.apply(this,[{url:b._images[a].url,
server:this.options.proxyURL,success:function(c){b._images[a].imgdata=c;b._images[a].loaded=!0;d.drawImage(b._images[a].imgdata,b._images[a].x,b._images[a].y,b._images[a].w,b._images[a].h);e.allImagesLoaded.apply(b)},error:function(a,d){k(b.element,"postcardimageerror")}}]):(d.drawImage(b._images[a].imgdata,b._images[a].x,b._images[a].y,b._images[a].w,b._images[a].h),e.allImagesLoaded.apply(b))},allImagesLoaded:function(){for(var a=0;a<this._images.length;a++){var b=this._images[a];if(b.loaded)a==
this._images.length-1&&b.loaded&&(this.allImagesLoaded=!0,k(this.element,"_loaded"),k(this.element,"postcardimagesloaded"));else{this.allImagesLoaded=!1;break}}},getloaded:function(){return this.allImagesLoaded},clear:function(){this._text.length=0;this._images.length=0;this._ctx.clearRect(0,0,this._width,this._height)},setFontToCtx:function(){var a=this.options.fontStyle+" normal "+this.options.fontWeight+" "+this.options.fontSize+" "+this.options.fontFamily;this._ctx.fillStyle=this.options.fontColor;
this._ctx.font=a},getFont:function(){return this.options.fontColor+" "+this.options.fontStyle+" "+this.options.fontWeight+" "+this.options.fontSize+" "+this.options.fontFamily},postImageToFacebook:function(a,b,d,c,f){b="------ThisIsTheBoundary1234567890\r\n"+('Content-Disposition: form-data; name="source"; filename="'+b+'"\r\n')+("Content-Type: "+d+"\r\n\r\n");for(d=0;d<c.length;++d)b+=String.fromCharCode(c[d]&255);b+="\r\n";b+="------ThisIsTheBoundary1234567890\r\n";b+='Content-Disposition: form-data; name="message"\r\n\r\n';
b+=f+"\r\n";b+="------ThisIsTheBoundary1234567890--\r\n";var e=new XMLHttpRequest;e.open("POST","https://graph.facebook.com/me/photos?access_token="+a,!0);e.onload=e.onerror=function(){console.log(e.responseText)};e.setRequestHeader("Content-Type","multipart/form-data; boundary=----ThisIsTheBoundary1234567890");e.sendAsBinary(b)}};HTMLCanvasElement.prototype.postcard=function(a){if(h[a])return h[a].apply(this,Array.prototype.slice.call(arguments,1));if("object"!==typeof a&&a)console.error("Method "+
a+" does not exist.");else return h.init.apply(this,arguments)}})(window,document);