function _testCSS(a){return a in document.documentElement.style}function _triggerEvent(a,b){if(window.CustomEvent)var c=new CustomEvent(b);else{var c=document.createEvent("CustomEvent");c.initCustomEvent(b,!0,!0)}a.dispatchEvent(c)}function _extend(a){a=a||{};for(var b=1;b<arguments.length;b++)if(arguments[b])for(var c in arguments[b])arguments[b].hasOwnProperty(c)&&(a[c]=arguments[b][c]);return a}function OrderedMap(){this.map={},this._karray=[],this._zarray=[]}function PostcardObject(a,b,c){var d={x:0,y:0,w:50,h:50,fill:"steelblue",selectable:!1,zindex:0,rotation:0};this.ctx=b,this.type=a,this.opts=_extend({},d,c),this.x=parseInt(this.opts.x,10),this.y=parseInt(this.opts.y,10),this.w=parseInt(this.opts.w,10),this.h=parseInt(this.opts.h,10)}function PostcardImageObject(a,b,c){function d(a){var b=/(ftp|http|https):\/\/(\w+:{0,1}\w*@)?(\S+)(:[0-9]+)?(\/|\/([\w#!:.?+=&%@!\-\/]))?/;if(a){var c="https:"===location.protocol,d=h.proxyURL+"?callback=?";if(!d||!b.test(d)||c&&0==d.indexOf("http:"))throw new Error("bad or insecure server url combination.");JSONP.get(d,{url:escape(a)},function(b){h.url=a,h.cache[h.url]=b,e(h.cache[h.url])})}}function e(a){var b=new Image;b.onload=function(){h._canvas.width=a.width,h._canvas.height=a.height,h.imgElm=this,h._ctx.drawImage(h.imgElm,0,0,h._canvas.width,h._canvas.height),h.opts.keepOriginal&&(h.origImgData=h._ctx.getImageData(0,0,h._canvas.width,h._canvas.height)),h.imageloaded=!0,_triggerEvent(h.ctx.canvas,"forcerender"),this.onload=f},b.src=a.data}function f(){console.log("imagerefresh"),_triggerEvent(h.ctx.canvas,"forcerender")}var g={keepOriginal:!0,crop:!1,cropX:0,cropY:0,cropW:0,cropH:0};this.opts=_extend({},g,c),PostcardObject.apply(this,["image",b,this.opts]),this.imageloaded=!1,this.cache={},this._canvas=document.createElement("canvas"),this._ctx=this._canvas.getContext("2d");var h=this;if(!a.length)throw new Error("empty URL string");d(a),this.changeURL=function(a){this.imageloaded=!1,a in this.cache?e(this.cache[a]):d(a)}}function PostcardTextObject(a,b,c){var d={fill:"#ffffff",style:"normal",weight:"normal",size:"16px",family:"sans-serif",fontString:"",centered:!1};this.opts=_extend({},d,c),PostcardObject.apply(this,["text",b,this.opts]),this.text=a;var e=this;this._canvas=document.createElement("canvas"),this._ctx=this._canvas.getContext("2d");var f=function(){e._ctx.font=e.getFont(),e.w=e._ctx.measureText(e.text).width,e.h=parseInt(e.opts.size,10)};this.opts.fontString.length?this.setFont(this.opts.fontString):f()}function Postcard(a,b){var c={height:"",width:"",proxyURL:SERVER_URL+"image_proxy.php",filename:"yourpostcard.png",renderInterval:"30",allowSelections:!1,backgroundColor:"#ffffff",fontFamily:"sans-serif",fontSize:"16px",fontColor:"#fff",fontStyle:"normal",fontWeight:"normal"},d={isOpera:!1,isFirefox:!1,isSafari:!1,isChrome:!1,isIE:!1};this.elm=a,this.opts=_extend({},c,b),this.height=this.opts.height=this.elm.height,this.width=this.opts.width=this.elm.width,this.startingZindex=1,this.ctx=this.elm.getContext("2d"),this.browser=d,this.browser.isOpera=!(!window.opera||!window.opera.version),this.browser.isFirefox=_testCSS("MozBoxSizing"),this.browser.isSafari=Object.prototype.toString.call(window.HTMLElement).indexOf("Constructor")>0,this.browser.isChrome=!this.browser.isSafari&&_testCSS("WebkitTransform"),this.browser.isIE=!1||_testCSS("msTransform"),document.defaultView&&document.defaultView.getComputedStyle&&(this.stylePaddingLeft=parseInt(document.defaultView.getComputedStyle(this.elm,null).paddingLeft,10)||0,this.stylePaddingTop=parseInt(document.defaultView.getComputedStyle(this.elm,null).paddingTop,10)||0,this.styleBorderLeft=parseInt(document.defaultView.getComputedStyle(this.elm,null).borderLeftWidth,10)||0,this.styleBorderTop=parseInt(document.defaultView.getComputedStyle(this.elm,null).borderTopWidth,10)||0);var e=document.body.parentNode;this.htmlTop=e.offsetTop,this.htmlLeft=e.offsetLeft,this.valid=!1,this.dragging=!1,this.selection=null,this.dragoffx=0,this.dragoffy=0;var f=this;PostcardImageObject.prototype.proxyURL=this.opts.proxyURL,JSONP.init({error:function(a){console.error("Failed to load : "+a.url)}}),this.renderingStack=new OrderedMap,setInterval(function(){f.render()},f.opts.renderInterval),this.addObject("__background__",0,{w:this.width,h:this.height,fill:this.opts.backgroundColor}),this.elm.addEventListener("forcerender",function(a){f.valid=!1}),this.elm.addEventListener("selectstart",function(a){return a.preventDefault(),!1},!1),this.elm.addEventListener("mousedown",function(a){f.dragging=!0,f.opts.allowSelections&&h(a)},!1),this.elm.addEventListener("mousemove",function(a){f.opts.allowSelections&&i(a)},!0),this.elm.addEventListener("mouseup",function(a){f.dragging=!1},!0);var g=function(a){var b,c,d=f.elm,e=0,g=0;if(void 0!==d.offsetParent)do e+=d.offsetLeft,g+=d.offsetTop;while(d=d.offsetParent);return e+=f.stylePaddingLeft+f.styleBorderLeft+f.htmlLeft,g+=f.stylePaddingTop+f.styleBorderTop+f.htmlTop,b=a.pageX-e,c=a.pageY-g,{x:b,y:c}},h=function(a){var b=g(a),c=b.x,d=b.y,e=0,h=null;return f.renderingStack.forEach(function(a,b,f){f.contains(c,d)&&b>=e&&(h=f)}),h?(f.dragoffx=b.x-h.x,f.dragoffy=b.y-h.y,f.selection=h,void(f.valid=!1)):void(f.selection&&(f.selection=null,f.valid=!1))},i=function(a){if(f.dragging){var b=g(a);f.selection.x=b.x-f.dragoffx,f.selection.y=b.y-f.dragoffy,f.valid=!1}};this.onMouseDown=function(a){this.userMouseDown=function(b){var c=g(b);a(c.x,c.y)},this.elm.addEventListener("mousedown",this.userMouseDown,!1)},this.onMouseMove=function(a){this.userMouseMove=function(b){var c=g(b);a(c.x,c.y)},this.elm.addEventListener("mousemove",this.userMouseMove,!0)},this.onMouseUp=function(a){this.userMouseUp=function(b){var c=g(b);a(c.x,c.y)},this.elm.addEventListener("mouseup",this.userMouseUp,!0)},this.clearMouseEvents=function(){this.userMouseDown&&this.elm.removeEventListener("mousedown",this.userMouseDown,!1),this.userMouseMove&&this.elm.removeEventListener("mousemove",this.userMouseMove,!0),this.userMouseUp&&this.elm.removeEventListener("mouseup",this.userMouseUp,!0)}}var Base64Binary={_keyStr:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",decodeArrayBuffer:function(a){var b=a.length/4*3,c=new ArrayBuffer(b);return this.decode(a,c),c},decode:function(a,b){var c=this._keyStr.indexOf(a.charAt(a.length-1)),d=this._keyStr.indexOf(a.charAt(a.length-2)),e=a.length/4*3;64==c&&e--,64==d&&e--;var f,g,h,i,j,k,l,m,n=0,o=0;for(f=new Uint8Array(b?b:e),a=a.replace(/[^A-Za-z0-9\+\/\=]/g,""),n=0;e>n;n+=3)j=this._keyStr.indexOf(a.charAt(o++)),k=this._keyStr.indexOf(a.charAt(o++)),l=this._keyStr.indexOf(a.charAt(o++)),m=this._keyStr.indexOf(a.charAt(o++)),g=j<<2|k>>4,h=(15&k)<<4|l>>2,i=(3&l)<<6|m,f[n]=g,64!=l&&(f[n+1]=h),64!=m&&(f[n+2]=i);return f}},JSONP=function(){function a(a,b){var c=document.createElement("script"),d=!1;c.src=a,c.async=!0;var f=b||h.error;"function"==typeof f&&(c.onerror=function(b){f({url:a,event:b})}),c.onload=c.onreadystatechange=function(){d||this.readyState&&"loaded"!==this.readyState&&"complete"!==this.readyState||(d=!0,c.onload=c.onreadystatechange=null,c&&c.parentNode&&c.parentNode.removeChild(c))},e||(e=document.getElementsByTagName("head")[0]),e.appendChild(c)}function b(a){return encodeURIComponent(a)}function c(c,d,e,i){var j,k=-1===(c||"").indexOf("?")?"?":"&";i=i||h.callbackName||"callback";var l=i+"_json"+ ++f;d=d||{};for(j in d)d.hasOwnProperty(j)&&(k+=b(j)+"="+b(d[j])+"&");return g[l]=function(a){e(a);try{delete g[l]}catch(b){}g[l]=null},a(c+k+i+"="+l),l}function d(a){h=a}var e,f=0,g=this,h={};return{get:c,init:d}}();void 0===XMLHttpRequest.prototype.sendAsBinary&&(XMLHttpRequest.prototype.sendAsBinary=function(a){var b=Array.prototype.map.call(a,function(a){return 255&a.charCodeAt(0)});this.send(new Uint8Array(b).buffer)});var SERVER_URL="http://lab.layerframe.com/postcard/scripts/";OrderedMap.prototype.assert=function(a){if(!(a in this.map))throw new Error('key: "'+a+'" does not exist')},OrderedMap.prototype.length=function(){return this._karray.length},OrderedMap.prototype.findFirst=function(a){var b=0;for(b;b<this._zarray.length;b++)if(this._zarray[b]>a)return b;return b},OrderedMap.prototype.add=function(a,b,c){if(this.exists(a))throw new Error("key already exists");if(0>b)throw new Error("z-index can't be less than 0");var d=this.findFirst(b);this._karray.splice(d,0,a),this._zarray.splice(d,0,b),this.map[a]=c},OrderedMap.prototype.remove=function(a){this.assert(a);var b=this._karray.indexOf(a);this._karray.splice(b,1),this._zarray.splice(b,1),delete this.map[a]},OrderedMap.prototype.exists=function(a){return a in this.map?!0:!1},OrderedMap.prototype.get=function(a){return this.assert(a),this.map[a]},OrderedMap.prototype.getZindex=function(a){this.assert(a);var b=this._karray.indexOf(a);return this._zarray[b]},OrderedMap.prototype.updateValue=function(a,b){this.assert(a),this.map[a]=b},OrderedMap.prototype.changeOrder=function(a,b){if(0>b)throw new Error("z-index can't be less than 0");var c=this.get(a);this.remove(a),this.add(a,b,c)},OrderedMap.prototype.toStart=function(a){var b=this.get(a);this.remove(a),this._karray.splice(0,0,a),this._zarray.splice(0,0,0),this.map[a]=b},OrderedMap.prototype.toEnd=function(a){var b=this._zarray[this._zarray.length-1];this.changeOrder(a,b)},OrderedMap.prototype.forEach=function(a){for(var b,c,d,e=0;e<this._karray.length;e++)b=this._karray[e],d=this._zarray[e],c=this.map[b],a(b,d,c)},OrderedMap.prototype.filter=function(a){var b=[];return this.forEach(function(c,d,e){a.apply(null,[c,d,e])&&b.push(e)}),b},PostcardObject.prototype.draw=function(){this.ctx.fillStyle=this.opts.fill,this.ctx.fillRect(this.x,this.y,this.w,this.h)},PostcardObject.prototype.contains=function(a,b){return this.x<=a&&this.x+this.w>=a&&this.y<=b&&this.y+this.h>=b},PostcardObject.prototype.update=function(a){this.opts=_extend({},this.opts,a),this.x=parseInt(this.opts.x,10),this.y=parseInt(this.opts.y,10),this.w=parseInt(this.opts.w,10),this.h=parseInt(this.opts.h,10)},PostcardImageObject.prototype=new PostcardObject,PostcardImageObject.prototype.constructor=PostcardImageObject,PostcardImageObject.prototype.draw=function(){if(this.imageloaded){var a=this.x,b=this.y;this.ctx.save(),this.opts.rotation>0&&(this.ctx.translate(this.x+this.w/2,this.y+this.h/2),this.ctx.rotate(this.opts.rotation*Math.PI/180),a=-this.w/2,b=-this.h/2),this.opts.crop?this.ctx.drawImage(this.imgElm,cropX,cropY,cropW,cropH,a,b,this.w,this.h):this.ctx.drawImage(this.imgElm,a,b,this.w,this.h),this.ctx.restore()}},PostcardImageObject.prototype.revert=function(){if(!this.opts.keepOriginal)throw new Error("original image wasn't preserved");this._ctx.putImageData(this.origImgData,0,0),this.imgElm.src=this._canvas.toDataURL()},PostcardImageObject.prototype.getOriginalImageData=function(){if(this.imageloaded&&this.opts.keepOriginal){var a=this._ctx.createImageData(this.origImgData.width,this.origImgData.height);return a.data.set(this.origImgData.data),a}throw new Error("image not loaded/not saving original")},PostcardImageObject.prototype.getCurrentImageData=function(){if(this.imageloaded)return this._ctx.getImageData(0,0,this._canvas.width,this._canvas.height);throw new Error("image not loaded")},PostcardImageObject.prototype.setImageData=function(a){this._ctx.putImageData(a,0,0),this.imgElm.src=this._canvas.toDataURL()},PostcardImageObject.prototype.getRotation=function(){return this.opts.rotation},PostcardImageObject.prototype.setRotation=function(a){this.opts.rotation=a%360,_triggerEvent(this.ctx.canvas,"forcerender")},PostcardTextObject.prototype=new PostcardObject,PostcardTextObject.prototype.constructor=PostcardTextObject,PostcardTextObject.prototype.draw=function(){this.ctx.save(),this.ctx.fillStyle=this.opts.fill,this.ctx.font=this.getFont(),this.ctx.fillText(this.text,this.x,this.y),this.ctx.restore()},PostcardTextObject.prototype.contains=function(a,b){return this.x<=a&&this.x+this.w>=a&&this.y>=b&&this.y-this.h<=b},PostcardTextObject.prototype.changeText=function(a){this.text=a,this.w=this._ctx.measureText(this.text).width,_triggerEvent(this.ctx.canvas,"forcerender")},PostcardTextObject.prototype.getFont=function(){return this.opts.style+" normal "+this.opts.weight+" "+this.opts.size+" "+this.opts.family},PostcardTextObject.prototype.setFont=function(a){var b=a.split(" ",4),c=a.slice(a.indexOf("px")+3);this.opts.fill=b[0],this.opts.style=b[1],this.opts.weight=b[2],this.opts.size=b[3],this.opts.family=c,this._ctx.font=this.getFont(),this.w=this._ctx.measureText(this.text).width,this.h=parseInt(this.opts.size,10),_triggerEvent(this.ctx.canvas,"forcerender")},Postcard.prototype.clear=function(){this.ctx.clearRect(0,0,this.width,this.height)},Postcard.prototype.render=function(){if(!this.valid){if(this.clear(),this.renderingStack.forEach(function(a,b,c){c.draw()}),null!=this.selection){this.ctx.strokeStyle="#CC0000",this.ctx.lineWidth="2";var a=this.selection;"text"==a.type?this.ctx.strokeRect(a.x,a.y-a.h,a.w,a.h):this.ctx.strokeRect(a.x,a.y,a.w,a.h)}this.valid=!0}},Postcard.prototype.get=function(a){return this.renderingStack.get(a)},Postcard.prototype.remove=function(a){return this.renderingStack.remove(a)},Postcard.prototype.getSome=function(a){return this.renderingStack.filter(a)},Postcard.prototype.getSelection=function(){return this.selection},Postcard.prototype.addObject=function(a,b,c){var d=a,e=this.startingZindex,f={};arguments.length>2?(e=arguments[1],f=arguments[2]):2==arguments.length&&("number"==typeof arguments[1]?e=arguments[1]:f=arguments[1]);var g=new PostcardObject("shape",this.ctx,f);this.renderingStack.add(d,e,g)},Postcard.prototype.addImage=function(a,b,c,d){var e=a,f=b,g=this.startingZindex,h={};if("string"!=typeof arguments[1])throw new Error("no url specified? id: "+e);arguments.length>3?(g=arguments[2],h=arguments[3]):3===arguments.length&&("number"==typeof arguments[2]?g=arguments[2]:h=arguments[2]);var i=new PostcardImageObject(f,this.ctx,h);this.renderingStack.add(e,g,i)},Postcard.prototype.addText=function(a,b,c,d){var e=a,f=b,g=this.startingZindex,h={family:this.opts.fontFamily,size:this.opts.fontSize,fill:this.opts.fontColor,style:this.opts.fontStyle,weight:this.opts.fontWeight};if("string"!=typeof arguments[1])throw new Error("no text specified? id: "+e);arguments.length>3?(g=arguments[2],h=_extend({},h,arguments[3])):3===arguments.length&&("number"==typeof arguments[2]?g=arguments[2]:h=h=_extend({},h,arguments[2]));var i=new PostcardTextObject(f,this.ctx,h);this.renderingStack.add(e,g,i)},Postcard.prototype.save=function(a){(this.browser.isSafari||this.browser.isIE)&&(alert("opening a new tab, just gotta [right click > save] the image. not ideal."),a.target.setAttribute("target","_blank")),a.target.href=this.elm.toDataURL(),a.target.download=this.opts.filename},Postcard.prototype["export"]=function(){return this.elm.toDataURL()};